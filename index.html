<?php
require_once("lib/HandleCSV.php");
require_once("lib/ScatterGraph.php");

//initialise variables
$mimeError = false;
$dataError = false;
$graphDataStr = null;
$x = null;
$y = null;

//handle form if submitted
if (isset($_POST['submit'])) {
	//Check if file was uploaded
	if (!empty($_FILES['upload']['name'])) {
		$csvData = new HandleCSV();
		$csvData->processCSV();
		$mimeError = $csvData->mimeError;
		$dataError = $csvData->dataError;
		$graphDataStr = $csvData->getGraphDataStr();
		if (isset($csvData->graphData) && !$mimeError && !$dataError) {
			$x = $csvData->getDataXStr();
			$y = $csvData->getDatayStr();
			$graph = new ScatterGraph($x,$y);
		}
	}
}
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
	<title></title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript" src="js/index.js"></script>
</head>
<body>
<h1>Hey Hey</h1>
<div id="graphcontainer">
<?php 
if (isset($csvData) && !$mimeError) {
	if ($dataError) {
		echo "<span class='error'>The CSV file contained invalid data, please ensure:<br/>
			  column1 = type (string)<br />
			  column2 = x-coordinate (int)<br />
			  column3 = y-coordinate (int)<br />
			  </span>";
	} else {
		echo "<div id='graphdiv'>" . $graph->outputGraph() . "</div>";
	}
} else {
	echo "<span class='error'>Upload CSV file to display graph</span>";
}
?>
</div>
<?php
echo "<form method='post' action='' enctype='multipart/form-data' onsubmit='return checksubmit(\"$graphDataStr\")'>";
if (isset($csvData->uniqueTypes) && !$mimeError && !$dataError) {
	echo "<p><label for='filter'>Filter:</label><br/>";
	echo "<select name='filter' id='filter' multiple>";
	foreach ($csvData->uniqueTypes as $type) {
		echo "<option value='$type'>$type</option>";
	}
	echo "</select></p>";
}
?>
<p><label for="upload">Filename:</label>
<input type="file" name="upload" id="upload" />
<?php
if ($mimeError) { 
	echo "<span class='error'>The file was not a CSV file, please try again</span>";
}
?>
<br /></p>
<p><input type="submit" name="submit" value="Submit" /></p>
</form>

</body>
</html>